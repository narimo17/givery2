<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VOCåˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆæ„›åª›ã‚±ãƒ¼ãƒ–ãƒ«ãƒ†ãƒ¬ãƒ“ï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Noto Sans JP (DECAå¯„ã›) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* =========================
       DECA Cloud-ish tokens
       ========================= */
    :root{
      --font-sans: "Noto Sans JP", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";

      /* 4px grid */
      --space-0: 0px;
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-7: 28px;
      --space-8: 32px;
      --space-10: 40px;

      /* Radius */
      --radius-sm: 8px;
      --radius-md: 10px;
      --radius-lg: 15px;

      /* Colors */
      --bg: #f5f7fa;
      --surface: #ffffff;
      --surface-2: #f8f9ff;
      --text: #2c3e50;
      --text-2: #333;
      --muted: #666;
      --muted-2: #7f8c8d;
      --border: #e1e8ed;

      --primary: #667eea;
      --primary-2: #3498db;
      --primary-3: #2980b9;

      --success-bg: #d4edda;
      --success-fg: #155724;
      --success-br: #c3e6cb;

      --danger-bg: #f8d7da;
      --danger-fg: #721c24;
      --danger-br: #f5c6cb;

      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.10);
      --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.12);
      --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.30);

      --focus: 0 0 0 3px rgba(102, 126, 234, 0.25);

      /* Charts palette */
      --chart-1: #36A2EB;
      --chart-2: #4BC0C0;
      --chart-3: #FFCE56;
      --chart-4: #9966FF;
      --chart-5: #FF6384;
      --chart-6: #2ecc71;
      --chart-7: #e67e22;
      --chart-8: #9b59b6;
      --chart-9: #95a5a6;
      --chart-10:#1abc9c;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--font-sans);
      background: var(--bg);
      min-height: 100vh;
      padding: 0;
      color: var(--text-2);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container { max-width: 100%; margin: 0; padding: 0; }

    .header {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      padding: 24px 40px;
      border-radius: 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      margin-bottom: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
      color: #ffffff;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .header-actions { display: flex; gap: 10px; }

    .nav-tabs {
      display: flex;
      background: var(--surface);
      border-radius: 0;
      box-shadow: var(--shadow-md);
      margin-bottom: 0;
      overflow: hidden;
      border-bottom: 1px solid var(--border);
    }

    .nav-tab {
      flex: 1;
      padding: 15px 20px;
      background: var(--surface);
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      border-bottom: 3px solid transparent;
    }

    .nav-tab.active {
      background: var(--surface-2);
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .nav-tab:hover:not(.active) {
      background: #f8f9fa;
      color: var(--text-2);
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .btn {
      padding: 10px 20px;
      border: 1px solid transparent;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
      user-select: none;
    }

    .btn:focus { outline: none; box-shadow: var(--focus); }

    .btn-primary { background: var(--primary-2); color: white; }
    .btn-primary:hover { background: var(--primary-3); box-shadow: 0 2px 8px rgba(52, 152, 219, 0.25); }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.18);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.25);
    }
    .btn-secondary:hover { background: rgba(255, 255, 255, 0.26); }

    .loading {
      text-align: center;
      padding: 40px;
      background: var(--surface);
      border-radius: 15px;
      margin: 20px 40px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin: 20px 40px;
      font-weight: 600;
      display:none;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      background: var(--surface);
    }
    .alert.success { background: var(--success-bg); color: var(--success-fg); border: 1px solid var(--success-br); }
    .alert.error { background: var(--danger-bg); color: var(--danger-fg); border: 1px solid var(--danger-br); }

    .kpi-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px 40px;
    }
    .kpi-card {
      background: var(--surface);
      padding: 24px;
      border-radius: 10px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.15s ease;
    }
    .kpi-card:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); border-color: rgba(52,152,219,0.55); }
    .kpi-icon { font-size: 40px; line-height: 1; }
    .kpi-content { flex: 1; }
    .kpi-label { font-size: 13px; color: var(--muted-2); margin-bottom: 6px; font-weight: 600; }
    .kpi-value { font-size: 28px; font-weight: 800; color: var(--text); }

    .charts-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin: 30px 40px;
    }
    .chart-container {
      background: var(--surface);
      padding: 24px;
      border-radius: 10px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
    }
    .chart-container h2 {
      font-size: 16px;
      margin-bottom: 20px;
      color: var(--text);
      font-weight: 700;
    }
    .chart-full-width { grid-column: 1 / -1; }

    .filters-section, .voc-list-section, .operators-section {
      background: var(--surface);
      padding: 24px;
      border-radius: 10px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      margin: 30px 40px;
    }
    .filters-section h2, .voc-list-section h2, .operators-section h2 {
      font-size: 16px;
      margin-bottom: 20px;
      color: var(--text);
      font-weight: 700;
    }
    .filters { display:flex; flex-wrap:wrap; gap:15px; align-items:flex-end; }
    .filter-group { display:flex; flex-direction:column; gap:8px; }
    .filter-group label { font-size: 14px; font-weight: 700; color: var(--muted); }
    .filter-select {
      padding: 10px 15px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      min-width: 220px;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background: var(--surface);
    }
    .filter-select:focus { outline:none; border-color: var(--primary); box-shadow: var(--focus); }

    .voc-list { display:flex; flex-direction:column; gap:15px; }
    .voc-item {
      padding: 20px;
      border: 1px solid #f0f0f0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--surface);
    }
    .voc-item:hover {
      border-color: rgba(102,126,234,0.55);
      background: var(--surface-2);
      transform: translateX(5px);
    }
    .voc-item-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; gap:12px; }
    .voc-item-title { font-size: 16px; font-weight: 700; color: var(--text-2); }
    .voc-item-badges { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .badge { padding: 4px 12px; border-radius: 999px; font-size: 12px; font-weight: 700; border: 1px solid transparent; }
    .badge.category { background: #e3f2fd; color: #1976d2; border-color: rgba(25,118,210,0.15); }
    .badge.risk-low { background: #d1ecf1; color: #0c5460; border-color: rgba(12,84,96,0.12); }
    .badge.risk-mid { background: #fff3cd; color: #856404; border-color: rgba(133,100,4,0.12); }
    .badge.risk-high { background: #f8d7da; color: #721c24; border-color: rgba(114,28,36,0.12); }

    .voc-item-meta { display:flex; gap:20px; font-size:13px; color: var(--muted); flex-wrap:wrap; }
    .voc-item-keywords { margin-top:10px; font-size:13px; color: var(--primary); }

    .operators-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    .operator-card {
      padding: 20px;
      border: 1px solid #f0f0f0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--surface);
    }
    .operator-card:hover {
      border-color: rgba(102,126,234,0.55);
      background: var(--surface-2);
      transform: translateY(-2px);
    }
    .operator-card h3 { font-size: 18px; font-weight: 800; color: var(--text-2); margin-bottom: 10px; }
    .operator-stats { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin-bottom: 15px; }
    .operator-stat { text-align:center; }
    .operator-stat-label { font-size:12px; color: var(--muted); margin-bottom:5px; font-weight:700; }
    .operator-stat-value { font-size:20px; font-weight:900; color: var(--text); }
    .operator-score-bar { background:#e0e0e0; border-radius:999px; height:20px; margin:10px 0; overflow:hidden; }
    .operator-score-fill { height:100%; background: linear-gradient(90deg, var(--primary), #4BC0C0); transition: width 0.2s ease; }

    .modal {
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background-color: var(--surface);
      margin: auto;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
    }
    .close {
      position: absolute;
      right: 20px; top: 20px;
      font-size: 32px;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
      line-height: 1;
    }
    .close:hover { color: #333; }
    #modalTitle { font-size: 22px; margin-bottom: 16px; color: var(--primary); font-weight: 900; }
    .modal-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--surface-2);
      border-radius: 12px;
      border: 1px solid rgba(102,126,234,0.12);
    }
    .modal-info-label { font-size: 12px; color: var(--muted); margin-bottom:5px; font-weight:800; }
    .modal-info-value { font-size: 16px; color: var(--text-2); font-weight:600; }
    .conversation {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.8;
      color: #333;
      border: 1px solid rgba(0,0,0,0.05);
    }

    code{
      background: rgba(102,126,234,0.10);
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(102,126,234,0.15);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }

    @media (max-width: 768px) {
      .header { flex-direction: column; gap: 20px; text-align: center; padding: 20px; }
      .header-actions { width: 100%; justify-content: center; }
      .nav-tabs { flex-direction: column; }
      .nav-tab { border-bottom: 1px solid #eee; border-right: none; }
      .kpi-section { grid-template-columns: 1fr; margin: 20px; }
      .charts-section { grid-template-columns: 1fr; margin: 20px; }
      .filters-section, .voc-list-section, .operators-section { margin: 20px; }
      .filters { flex-direction: column; align-items: stretch; }
      .filter-select { width: 100%; min-width: unset; }
      .modal-content { width: 95%; padding: 20px; }
      .operators-grid { grid-template-columns: 1fr; }
    }

    .empty-state { text-align:center; padding: 60px 20px; color:#999; }
    .empty-state-text { font-size: 18px; margin-bottom: 10px; font-weight: 800; }
    .empty-state-hint { font-size: 14px; color:#aaa; }
  </style>
</head>

<body>
<div class="container">
  <header class="header">
    <h1>ğŸ“Š VOCåˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆæ„›åª›ã‚±ãƒ¼ãƒ–ãƒ«ãƒ†ãƒ¬ãƒ“ï¼‰</h1>
    <div class="header-actions">
      <button class="btn btn-primary" onclick="showTab('operator', event)">ğŸ‘¥ ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼è©•ä¾¡</button>
      <button class="btn btn-primary" onclick="showTab('dashboard', event)">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
      <button id="refreshBtn" class="btn btn-secondary">ğŸ”„ æ›´æ–°</button>
    </div>
  </header>

  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showTab('dashboard', event)">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
    <button class="nav-tab" onclick="showTab('voc-management', event)">ğŸ“‹ VOCç®¡ç†</button>
    <button class="nav-tab" onclick="showTab('operator', event)">ğŸ‘¥ ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼è©•ä¾¡</button>
  </div>

  <div id="loading" class="loading" style="display:none;">
    <div class="spinner"></div>
    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>

  <div id="alert" class="alert"></div>

  <!-- Dashboard Tab -->
  <div id="dashboard" class="tab-content active">
    <section class="kpi-section">
      <div class="kpi-card">
        <div class="kpi-icon">ğŸ“</div>
        <div class="kpi-content">
          <div class="kpi-label">ç·VOCä»¶æ•°</div>
          <div class="kpi-value" id="totalRecords">-</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">âš ï¸</div>
        <div class="kpi-content">
          <div class="kpi-label">è§£ç´„ãƒªã‚¹ã‚¯ï¼ˆé«˜ï¼‰å‰²åˆ</div>
          <div class="kpi-value" id="highRiskRate">-</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">â­</div>
        <div class="kpi-content">
          <div class="kpi-label">å¹³å‡ã‚¹ã‚³ã‚¢ï¼ˆ4é …ç›®ï¼‰</div>
          <div class="kpi-value" id="avgScoreAll">-</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">ğŸ‘¤</div>
        <div class="kpi-content">
          <div class="kpi-label">ãƒ¦ãƒ‹ãƒ¼ã‚¯OPæ•°</div>
          <div class="kpi-value" id="uniqueOperators">-</div>
        </div>
      </div>
    </section>

    <section class="charts-section">
      <div class="chart-container">
        <h2>ğŸ“Š å…¥é›»ç›®çš„(å¤§åˆ†é¡) åˆ¥ä»¶æ•°</h2>
        <canvas id="categoryChart"></canvas>
      </div>
      <div class="chart-container">
        <h2>ğŸ”‘ é »å‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ TOP10ï¼ˆä¼šè©±è¦ç´„ã‹ã‚‰ç°¡æ˜“æŠ½å‡ºï¼‰</h2>
        <canvas id="keywordChart"></canvas>
      </div>
      <div class="chart-container chart-full-width">
        <h2>ğŸ“ˆ è§£ç´„ãƒªã‚¹ã‚¯åˆ†å¸ƒ</h2>
        <canvas id="riskChart"></canvas>
      </div>
    </section>

    <section class="filters-section">
      <h2>ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h2>
      <div class="filters">
        <div class="filter-group">
          <label for="categoryFilter">å…¥é›»ç›®çš„(å¤§åˆ†é¡)</label>
          <select id="categoryFilter" class="filter-select">
            <option value="">ã™ã¹ã¦</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="riskFilter">è§£ç´„ãƒªã‚¹ã‚¯</label>
          <select id="riskFilter" class="filter-select">
            <option value="">ã™ã¹ã¦</option>
            <option value="ä½">ä½</option>
            <option value="ä¸­">ä¸­</option>
            <option value="é«˜">é«˜</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="operatorFilter">ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼å</label>
          <select id="operatorFilter" class="filter-select">
            <option value="">ã™ã¹ã¦</option>
          </select>
        </div>
        <button id="applyFilters" class="btn btn-primary">é©ç”¨</button>
        <button id="clearFilters" class="btn btn-secondary" style="color:#2c3e50;background:white;border:1px solid #e1e8ed;">ã‚¯ãƒªã‚¢</button>
      </div>
    </section>

    <section class="voc-list-section">
      <h2>ğŸ“‹ VOCä¸€è¦§ï¼ˆå…ˆé ­50ä»¶è¡¨ç¤ºï¼‰</h2>
      <div id="vocList" class="voc-list"></div>
    </section>
  </div>

  <!-- VOC Management Tab -->
  <div id="voc-management" class="tab-content">
    <section class="filters-section">
      <h2>ğŸ“¥ ãƒ‡ãƒ¼ã‚¿</h2>
      <p style="font-size:14px;color:#666;line-height:1.6;">
        ã“ã®ãƒ‡ãƒ¢ã¯ <code>data/voc.json</code> ã‚’èª­ã¿è¾¼ã¿ã€ã‚«ãƒ†ã‚´ãƒªãƒ»ãƒªã‚¹ã‚¯ãƒ»ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼åˆ¥ã«é›†è¨ˆã—ã¾ã™ã€‚<br/>
        ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ: <code>generate_dummy_min.ps1</code>
      </p>
      <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn btn-primary" id="downloadJson">ğŸ“‹ voc.json ã‚’é–‹ã</button>
        <button class="btn btn-primary" id="downloadTsv">ğŸ“Š voc.tsv ã‚’é–‹ã</button>
      </div>
    </section>

    <section class="voc-list-section">
      <h2>ğŸ“‹ VOCä¸€è¦§ï¼ˆå…ˆé ­100ä»¶ï¼‰</h2>
      <div id="vocList2" class="voc-list"></div>
    </section>
  </div>

  <!-- Operator Tab -->
  <div id="operator" class="tab-content">
    <section class="kpi-section">
      <div class="kpi-card">
        <div class="kpi-icon">ğŸ‘¤</div>
        <div class="kpi-content">
          <div class="kpi-label">è©•ä¾¡å¯¾è±¡ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼</div>
          <div class="kpi-value" id="totalOperators">-</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">ğŸ“</div>
        <div class="kpi-content">
          <div class="kpi-label">ç·ã‚±ãƒ¼ã‚¹æ•°</div>
          <div class="kpi-value" id="totalCases">-</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">â­</div>
        <div class="kpi-content">
          <div class="kpi-label">å¹³å‡ã‚¹ã‚³ã‚¢ï¼ˆå…¨OPï¼‰</div>
          <div class="kpi-value" id="avgScoreOps">-</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">ğŸ§¾</div>
        <div class="kpi-content">
          <div class="kpi-label">å¹³å‡å¿œå¯¾ã‚¹ã‚³ã‚¢ï¼ˆSoftï¼‰</div>
          <div class="kpi-value" id="avgSoftOps">-</div>
        </div>
      </div>
    </section>

    <section class="operators-section">
      <h2>ğŸ‘¥ ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ä¸€è¦§</h2>
      <div id="operatorsList" class="operators-grid"></div>
    </section>

    <section class="charts-section">
      <div class="chart-container chart-full-width">
        <h2>ğŸ“Š ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼åˆ¥ å¹³å‡ã‚¹ã‚³ã‚¢</h2>
        <canvas id="operatorScoreChart"></canvas>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div id="vocModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="modalTitle">VOCè©³ç´°</h2>
      <div id="modalBody"></div>
    </div>
  </div>
</div>

<script>
  // -------- State --------
  let ALL = [];
  let FILTERED = [];
  let charts = { category:null, keyword:null, risk:null, opScore:null };

  const MAX_LIST = 50;
  const MAX_LIST2 = 100;

  // -------- Utilities --------
  function showLoading(show){
    document.getElementById('loading').style.display = show ? 'block' : 'none';
  }

  function showAlert(type, msg){
    const el = document.getElementById('alert');
    el.className = 'alert ' + type;
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(()=> el.style.display='none', 3500);
  }

  function safeNum(x){
    const n = Number(x);
    return Number.isFinite(n) ? n : null;
  }

  function avg(nums){
    const xs = nums.filter(n => Number.isFinite(n));
    if (!xs.length) return null;
    return xs.reduce((a,b)=>a+b,0) / xs.length;
  }

  function fmt(n, digits=1){
    if (n === null || n === undefined) return '-';
    if (!Number.isFinite(n)) return '-';
    return n.toFixed(digits);
  }

  function normalizeRisk(r){
    const s = String(r ?? '').trim().toLowerCase();
    if (!s) return '';
    if (s === 'ä½' || s === 'low') return 'ä½';
    if (s === 'ä¸­' || s === 'medium' || s === 'mid') return 'ä¸­';
    if (s === 'é«˜' || s === 'high') return 'é«˜';
    // fallback: if contains JP
    if (s.includes('ä½')) return 'ä½';
    if (s.includes('ä¸­')) return 'ä¸­';
    if (s.includes('é«˜')) return 'é«˜';
    return String(r ?? '').trim();
  }

  function riskBadge(r){
    const rr = normalizeRisk(r);
    if (rr === 'é«˜') return 'risk-high';
    if (rr === 'ä¸­') return 'risk-mid';
    return 'risk-low';
  }

  function tokenize(text){
    if (!text) return [];
    return text
      .replace(/[0-9]+/g,' ')
      .replace(/[!"#$%&'()*+,\-./:;<=>?@[\\\]^_`{|}~]/g,' ')
      .replace(/\s+/g,' ')
      .trim()
      .split(' ')
      .filter(t => t.length >= 2 && t.length <= 20);
  }

  function buildKeywordsTop(records, topN=10){
    const map = new Map();
    for (const r of records){
      const toks = tokenize(r["ä¼šè©±è¦ç´„"] || '');
      for (const t of toks){
        map.set(t, (map.get(t)||0) + 1);
      }
    }
    return [...map.entries()]
      .sort((a,b)=> b[1]-a[1])
      .slice(0, topN)
      .map(([keyword,count])=>({keyword,count}));
  }

  function unique(arr){
    return [...new Set(arr)];
  }

  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, c => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
  }

  // -------- Data Loading --------
  async function loadVoc(){
    showLoading(true);
    try{
      // cache bust
      const url = './data/voc.json?v=' + Date.now();
      const res = await fetch(url);
      if (!res.ok) throw new Error('voc.json ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“: HTTP ' + res.status);
      const data = await res.json();
      if (!Array.isArray(data)) throw new Error('voc.json ã®å½¢å¼ãŒä¸æ­£ã§ã™ï¼ˆé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰');

      // attach id
      ALL = data.map((r, idx) => ({ id: idx + 1, ...r }));
      FILTERED = ALL;

      initializeUI();
      renderAll();

      showAlert('success', 'ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: ' + ALL.length + 'ä»¶');
    } catch(e){
      console.error(e);
      showAlert('error', String(e.message || e));
    } finally{
      showLoading(false);
    }
  }

  // -------- UI Init --------
  function initializeUI(){
    const categories = unique(ALL.map(r => r["å…¥é›»ç›®çš„(å¤§åˆ†é¡)"] || 'ä¸æ˜')).sort();
    const operators  = unique(ALL.map(r => r["ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼å"] || 'ä¸æ˜')).sort();

    const categoryFilter = document.getElementById('categoryFilter');
    categoryFilter.innerHTML =
      `<option value="">ã™ã¹ã¦</option>` +
      categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');

    const operatorFilter = document.getElementById('operatorFilter');
    operatorFilter.innerHTML =
      `<option value="">ã™ã¹ã¦</option>` +
      operators.map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('');

    document.getElementById('applyFilters').onclick = () => {
      applyFilters();
      renderAll();
    };
    document.getElementById('clearFilters').onclick = () => {
      document.getElementById('categoryFilter').value = '';
      document.getElementById('riskFilter').value = '';
      document.getElementById('operatorFilter').value = '';
      FILTERED = ALL;
      renderAll();
    };

    document.getElementById('refreshBtn').onclick = () => loadVoc();
    document.getElementById('downloadJson').onclick = () => window.open('./data/voc.json', '_blank');
    document.getElementById('downloadTsv').onclick = () => window.open('./data/voc.tsv', '_blank');
  }

  function applyFilters(){
    const cat = document.getElementById('categoryFilter').value;
    const risk = document.getElementById('riskFilter').value;
    const op = document.getElementById('operatorFilter').value;

    FILTERED = ALL.filter(r => {
      if (cat && (r["å…¥é›»ç›®çš„(å¤§åˆ†é¡)"] || '') !== cat) return false;

      if (risk){
        const rr = normalizeRisk(r["è§£ç´„ãƒªã‚¹ã‚¯åˆ¤å®š"] || '');
        if (rr !== risk) return false;
      }

      if (op && (r["ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼å"] || '') !== op) return false;
      return true;
    });
  }

  // -------- Rendering --------
  function renderAll(){
    renderKpis();
    renderCharts();
    renderVocLists();
    renderOperatorTab();
  }

  function renderKpis(){
    document.getElementById('totalRecords').textContent = FILTERED.length.toLocaleString();

    const high = FILTERED.filter(r => normalizeRisk(r["è§£ç´„ãƒªã‚¹ã‚¯åˆ¤å®š"]) === "é«˜").length;
    const rate = FILTERED.length ? (high / FILTERED.length * 100) : 0;
    document.getElementById('highRiskRate').textContent = FILTERED.length ? (rate.toFixed(1) + "%") : "-";

    const ops = unique(FILTERED.map(r => r["ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼å"] || "ä¸æ˜"));
    document.getElementById('uniqueOperators').textContent = ops.length.toLocaleString();

    const scores = FILTERED.map(r => {
      const a = safeNum(r["è©•ä¾¡_Soft_ç‚¹æ•°"]);
      const b = safeNum(r["è©•ä¾¡_HardåŸºæœ¬_ç‚¹æ•°"]);
      const c = safeNum(r["è©•ä¾¡_Hardå°‚é–€_ç‚¹æ•°"]);
      const d = safeNum(r["è©•ä¾¡_åˆ¤æ–­ææ¡ˆ_ç‚¹æ•°"]);
      return avg([a,b,c,d]);
    });
    document.getElementById('avgScoreAll').textContent = fmt(avg(scores), 2);
  }

  function destroyChart(ch){
    if (ch) ch.destroy();
  }

  function renderCharts(){
    // category chart
    const catMap = new Map();
    for (const r of FILTERED){
      const k = r["å…¥é›»ç›®çš„(å¤§åˆ†é¡)"] || "ä¸æ˜";
      catMap.set(k, (catMap.get(k)||0) + 1);
    }
    const catLabels = [...catMap.keys()];
    const catVals = catLabels.map(l => catMap.get(l));

    destroyChart(charts.category);
    charts.category = new Chart(document.getElementById('categoryChart'), {
      type: 'doughnut',
      data: {
        labels: catLabels,
        datasets: [{
          data: catVals,
          backgroundColor: [
            getComputedStyle(document.documentElement).getPropertyValue('--chart-1').trim(),
            getComputedStyle(document.documentElement).getPropertyValue('--chart-2').trim(),
            getComputedStyle(document.documentElement).getPropertyValue('--chart-3').trim(),
            getComputedStyle(document.documentElement).getPropertyValue('--chart-4').trim(),
            getComputedStyle(document.documentElement).getPropertyValue('--chart-5').trim(),
            getComputedStyle(document.documentElement).getPropertyValue('--chart-6').trim(),
            getComputedStyle(document.documentElement).getPropertyValue('--chart-7').trim(),
            getComputedStyle(document.documentElement).getPropertyValue('--chart-8').trim(),
            getComputedStyle(document.documentElement).getPropertyValue('--chart-9').trim(),
            getComputedStyle(document.documentElement).getPropertyValue('--chart-10').trim()
          ],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom', labels: { padding: 16, font: { size: 12 } } }
        }
      }
    });

    // keyword chart
    const topKeywords = buildKeywordsTop(FILTERED, 10);
    destroyChart(charts.keyword);
    charts.keyword = new Chart(document.getElementById('keywordChart'), {
      type: 'bar',
      data: {
        labels: topKeywords.map(k => k.keyword),
        datasets: [{
          label: 'å‡ºç¾å›æ•°',
          data: topKeywords.map(k => k.count),
          backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--chart-1').trim(),
          borderColor: '#2E86AB',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 10 } },
          x: { ticks: { maxRotation: 45 } }
        },
        plugins: { legend: { display:false } }
      }
    });

    // risk chart
    const low = FILTERED.filter(r => normalizeRisk(r["è§£ç´„ãƒªã‚¹ã‚¯åˆ¤å®š"]) === "ä½").length;
    const mid = FILTERED.filter(r => normalizeRisk(r["è§£ç´„ãƒªã‚¹ã‚¯åˆ¤å®š"]) === "ä¸­").length;
    const high = FILTERED.filter(r => normalizeRisk(r["è§£ç´„ãƒªã‚¹ã‚¯åˆ¤å®š"]) === "é«˜").length;

    destroyChart(charts.risk);
    charts.risk = new Chart(document.getElementById('riskChart'), {
      type: 'bar',
      data: {
        labels: ['ä½','ä¸­','é«˜'],
        datasets: [{
          label: 'ä»¶æ•°',
          data: [low, mid, high],
          backgroundColor: [
            getComputedStyle(document.documentElement).getPropertyValue('--chart-2').trim(),
            getComputedStyle(document.documentElement).getPropertyValue('--chart-3').trim(),
            getComputedStyle(document.documentElement).getPropertyValue('--chart-5').trim()
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero:true } },
        plugins: { legend: { display:false } }
      }
    });
  }

  function renderVocLists(){
    // list 1 (50)
    const list = document.getElementById('vocList');
    const items = FILTERED.slice(0, MAX_LIST);
    if (!items.length){
      list.innerHTML = `<div class="empty-state"><div class="empty-state-text">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div><div class="empty-state-hint">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„</div></div>`;
    } else {
      list.innerHTML = items.map(r => vocItemHtml(r)).join('');
    }

    // list 2 (100)
    const list2 = document.getElementById('vocList2');
    const items2 = FILTERED.slice(0, MAX_LIST2);
    if (!items2.length){
      list2.innerHTML = `<div class="empty-state"><div class="empty-state-text">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div><div class="empty-state-hint">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„</div></div>`;
    } else {
      list2.innerHTML = items2.map(r => vocItemHtml(r)).join('');
    }
  }

  function vocItemHtml(r){
    const title = `${r["é€šè©±æ—¥æ™‚"] || "æ—¥ä»˜ä¸æ˜"} / ${r["ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼å"] || "ä¸æ˜"} / ${r["å…¥é›»ç›®çš„(å¤§åˆ†é¡)"] || "ä¸æ˜"}`;
    const trigger = r["å…·ä½“çš„èª²é¡Œ(Trigger)"] || "";
    const risk = normalizeRisk(r["è§£ç´„ãƒªã‚¹ã‚¯åˆ¤å®š"] || "ä½");
    const badgeClass = riskBadge(risk);
    const meta1 = `å¥‘ç´„: ${r["å¥‘ç´„çŠ¶æ³(æ¨æ¸¬)"] || "ä¸æ˜"}`;
    const meta2 = `é¡§å®¢å±æ€§: ${r["é¡§å®¢å±æ€§(æ¨å®š)"] || "ä¸æ˜"}`;
    const meta3 = `Soft/HB/HP/ææ¡ˆ: ${r["è©•ä¾¡_Soft_ç‚¹æ•°"]||"-"}/${r["è©•ä¾¡_HardåŸºæœ¬_ç‚¹æ•°"]||"-"}/${r["è©•ä¾¡_Hardå°‚é–€_ç‚¹æ•°"]||"-"}/${r["è©•ä¾¡_åˆ¤æ–­ææ¡ˆ_ç‚¹æ•°"]||"-"}`;

    return `
      <div class="voc-item" onclick="showVOCDetail(${r.id})">
        <div class="voc-item-header">
          <div class="voc-item-title">${escapeHtml(title)}</div>
          <div class="voc-item-badges">
            <span class="badge category">${escapeHtml(r["å…¥é›»ç›®çš„(å¤§åˆ†é¡)"] || "ä¸æ˜")}</span>
            <span class="badge ${badgeClass}">è§£ç´„ãƒªã‚¹ã‚¯: ${escapeHtml(risk || "ä½")}</span>
          </div>
        </div>
        <div class="voc-item-meta">
          <span>${escapeHtml(meta1)}</span>
          <span>${escapeHtml(meta2)}</span>
          <span>${escapeHtml(meta3)}</span>
        </div>
        <div class="voc-item-keywords">è¦ç‚¹: ${escapeHtml(trigger)}</div>
      </div>
    `;
  }

  function renderOperatorTab(){
    // aggregate by operator
    const byOp = new Map();
    for (const r of FILTERED){
      const op = r["ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼å"] || "ä¸æ˜";
      if (!byOp.has(op)) byOp.set(op, []);
      byOp.get(op).push(r);
    }
    const ops = [...byOp.keys()].sort();

    document.getElementById('totalOperators').textContent = ops.length.toLocaleString();
    document.getElementById('totalCases').textContent = FILTERED.length.toLocaleString();

    // compute overall averages
    const allSoft = avg(FILTERED.map(r => safeNum(r["è©•ä¾¡_Soft_ç‚¹æ•°"])));
    const allAvgScore = avg(FILTERED.map(r => avg([
      safeNum(r["è©•ä¾¡_Soft_ç‚¹æ•°"]),
      safeNum(r["è©•ä¾¡_HardåŸºæœ¬_ç‚¹æ•°"]),
      safeNum(r["è©•ä¾¡_Hardå°‚é–€_ç‚¹æ•°"]),
      safeNum(r["è©•ä¾¡_åˆ¤æ–­ææ¡ˆ_ç‚¹æ•°"])
    ])));

    document.getElementById('avgScoreOps').textContent = fmt(allAvgScore, 2);
    document.getElementById('avgSoftOps').textContent = fmt(allSoft, 2);

    // operator cards
    const container = document.getElementById('operatorsList');
    container.innerHTML = ops.map(op => {
      const rs = byOp.get(op);
      const avgScore = avg(rs.map(r => avg([
        safeNum(r["è©•ä¾¡_Soft_ç‚¹æ•°"]),
        safeNum(r["è©•ä¾¡_HardåŸºæœ¬_ç‚¹æ•°"]),
        safeNum(r["è©•ä¾¡_Hardå°‚é–€_ç‚¹æ•°"]),
        safeNum(r["è©•ä¾¡_åˆ¤æ–­ææ¡ˆ_ç‚¹æ•°"])
      ])));
      const soft = avg(rs.map(r => safeNum(r["è©•ä¾¡_Soft_ç‚¹æ•°"])));
      const hb = avg(rs.map(r => safeNum(r["è©•ä¾¡_HardåŸºæœ¬_ç‚¹æ•°"])));
      const hp = avg(rs.map(r => safeNum(r["è©•ä¾¡_Hardå°‚é–€_ç‚¹æ•°"])));
      const pr = avg(rs.map(r => safeNum(r["è©•ä¾¡_åˆ¤æ–­ææ¡ˆ_ç‚¹æ•°"])));

      const pct = avgScore ? Math.max(0, Math.min(100, (avgScore/5)*100)) : 0;

      return `
        <div class="operator-card" onclick="showOperatorDetail('${escapeHtml(op)}')">
          <h3>${escapeHtml(op)}</h3>
          <div class="operator-stats">
            <div class="operator-stat"><div class="operator-stat-label">ã‚±ãƒ¼ã‚¹æ•°</div><div class="operator-stat-value">${rs.length}</div></div>
            <div class="operator-stat"><div class="operator-stat-label">å¹³å‡ï¼ˆç·åˆï¼‰</div><div class="operator-stat-value">${fmt(avgScore,2)}</div></div>
            <div class="operator-stat"><div class="operator-stat-label">Soft</div><div class="operator-stat-value">${fmt(soft,2)}</div></div>
            <div class="operator-stat"><div class="operator-stat-label">Hard(åŸºæœ¬)</div><div class="operator-stat-value">${fmt(hb,2)}</div></div>
            <div class="operator-stat"><div class="operator-stat-label">Hard(å°‚é–€)</div><div class="operator-stat-value">${fmt(hp,2)}</div></div>
            <div class="operator-stat"><div class="operator-stat-label">åˆ¤æ–­ææ¡ˆ</div><div class="operator-stat-value">${fmt(pr,2)}</div></div>
          </div>
          <div class="operator-score-bar"><div class="operator-score-fill" style="width:${pct}%"></div></div>
        </div>
      `;
    }).join('');

    // operator score chart (top 12 by avgScore)
    const ranking = ops.map(op => {
      const rs = byOp.get(op);
      const avgScore = avg(rs.map(r => avg([
        safeNum(r["è©•ä¾¡_Soft_ç‚¹æ•°"]),
        safeNum(r["è©•ä¾¡_HardåŸºæœ¬_ç‚¹æ•°"]),
        safeNum(r["è©•ä¾¡_Hardå°‚é–€_ç‚¹æ•°"]),
        safeNum(r["è©•ä¾¡_åˆ¤æ–­ææ¡ˆ_ç‚¹æ•°"])
      ])));
      return { op, avgScore: avgScore || 0 };
    }).sort((a,b)=> b.avgScore - a.avgScore).slice(0, 12);

    if (document.getElementById('operatorScoreChart')){
      if (charts.opScore) charts.opScore.destroy();
      charts.opScore = new Chart(document.getElementById('operatorScoreChart'), {
        type: 'bar',
        data: {
          labels: ranking.map(x=>x.op),
          datasets: [{
            label: 'å¹³å‡ã‚¹ã‚³ã‚¢',
            data: ranking.map(x=>x.avgScore),
            backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim(),
            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim(),
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero:true, max:5, ticks:{ stepSize:0.5 } }
          },
          plugins: { legend: { display:false } }
        }
      });
    }
  }

  // -------- Modal --------
  function showVOCDetail(vocId){
    const r = FILTERED.find(x => x.id === vocId) || ALL.find(x => x.id === vocId);
    if (!r) return;

    document.getElementById('modalTitle').textContent = `VOCè©³ç´° #${r.id}`;
    const info = [
      ["é€šè©±æ—¥æ™‚", r["é€šè©±æ—¥æ™‚"]],
      ["ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼å", r["ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼å"]],
      ["é¡§å®¢å±æ€§(æ¨å®š)", r["é¡§å®¢å±æ€§(æ¨å®š)"]],
      ["å¥‘ç´„çŠ¶æ³(æ¨æ¸¬)", r["å¥‘ç´„çŠ¶æ³(æ¨æ¸¬)"]],
      ["å…¥é›»ç›®çš„(å¤§åˆ†é¡)", r["å…¥é›»ç›®çš„(å¤§åˆ†é¡)"]],
      ["è§£ç´„ãƒªã‚¹ã‚¯åˆ¤å®š", normalizeRisk(r["è§£ç´„ãƒªã‚¹ã‚¯åˆ¤å®š"])],
      ["è§£ç´„ãƒªã‚¹ã‚¯åˆ¤å®š_è©³ç´°", r["è§£ç´„ãƒªã‚¹ã‚¯åˆ¤å®š_è©³ç´°"]],
      ["å…·ä½“çš„èª²é¡Œ(Trigger)", r["å…·ä½“çš„èª²é¡Œ(Trigger)"]],
      ["è§£æ±ºãƒ—ãƒ­ã‚»ã‚¹(Action)", r["è§£æ±ºãƒ—ãƒ­ã‚»ã‚¹(Action)"]],
      ["ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆãƒ»äºˆå…†", r["ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆãƒ»äºˆå…†"]],
      ["ä¼šè©±è¦ç´„", r["ä¼šè©±è¦ç´„"]],
    ];

    document.getElementById('modalBody').innerHTML = `
      <div class="modal-info">
        ${info.map(([k,v])=>`
          <div class="modal-info-item">
            <div class="modal-info-label">${escapeHtml(k)}</div>
            <div class="modal-info-value">${escapeHtml(v ?? '-')}</div>
          </div>
        `).join('')}
      </div>

      <div class="modal-content-section">
        <h3 style="font-size:18px;margin-bottom:10px;color:#333;">ä¼šè©±å…¨æ–‡(æ•´å½¢æ¸ˆ)</h3>
        <div class="conversation">${escapeHtml(r["ä¼šè©±å…¨æ–‡(æ•´å½¢æ¸ˆ)"] || "")}</div>
      </div>
    `;
    document.getElementById('vocModal').style.display = 'flex';
  }

  function closeModal(){
    document.getElementById('vocModal').style.display = 'none';
  }

  window.onclick = function(event) {
    const modal = document.getElementById('vocModal');
    if (event.target === modal) modal.style.display = 'none';
  }

  // -------- Tabs --------
  function showTab(tabName, ev){
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

    document.getElementById(tabName).classList.add('active');
    if (ev && ev.target && ev.target.classList.contains('nav-tab')){
      ev.target.classList.add('active');
    } else {
      const map = { "dashboard":0, "voc-management":1, "operator":2 };
      const idx = map[tabName];
      const tabs = document.querySelectorAll('.nav-tab');
      if (tabs[idx]) tabs[idx].classList.add('active');
    }
  }

  // NOTE: å…ƒHTMLã«ã¯æœªå®šç¾©ã ã£ãŸã®ã§å®‰å…¨ã«å®Ÿè£…ï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚å£Šã‚Œãªã„ï¼‰
  function showOperatorDetail(operatorName){
    showAlert('success', 'ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼: ' + operatorName + 'ï¼ˆè©³ç´°ã¯ä»Šå¾Œæ‹¡å¼µã§ãã¾ã™ï¼‰');
  }

  // -------- Boot --------
  window.addEventListener('load', () => {
    // fake load feeling
    showLoading(true);
    setTimeout(() => loadVoc(), 600);
  });
</script>
</body>
</html>
