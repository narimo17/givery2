<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>愛媛ケーブルテレビ｜VOCダッシュボード（デモ）</title>
  <meta name="description" content="愛媛ケーブルテレビ向け VOC（コールセンター文字起こし由来の構造化要約）ダッシュボード デモ" />

  <!-- Typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* =========================
       DECA Cloud-ish tokens
       ========================= */
    :root{
      /* Base */
      --font-sans: "Noto Sans JP", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --radius-xs: 6px;
      --radius-sm: 10px;
      --radius-md: 14px;
      --radius-lg: 18px;

      /* 4px grid */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-7: 28px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;

      /* Colors (semantic) */
      --bg: #0b1020;
      --surface: rgba(255,255,255,0.06);
      --surface-2: rgba(255,255,255,0.10);
      --card: rgba(255,255,255,0.08);
      --card-2: rgba(255,255,255,0.10);
      --border: rgba(255,255,255,0.14);
      --border-strong: rgba(255,255,255,0.22);

      --text: rgba(255,255,255,0.92);
      --text-muted: rgba(255,255,255,0.70);
      --text-faint: rgba(255,255,255,0.55);

      --primary: #6ea8ff;
      --primary-2: #8fc1ff;
      --secondary: #b1b7c8;
      --accent: #66e3c4;
      --destructive: #ff6b6b;
      --warning: #ffcc66;
      --success: #63e6be;

      /* Charts */
      --chart-1: #6ea8ff;
      --chart-2: #66e3c4;
      --chart-3: #ffcc66;
      --chart-4: #c084fc;
      --chart-5: #ff6b6b;

      /* Shadows */
      --shadow-sm: 0 6px 18px rgba(0,0,0,.24);
      --shadow-md: 0 14px 44px rgba(0,0,0,.34);

      /* Focus */
      --focus: 0 0 0 3px rgba(110,168,255,.35);

      /* Motion */
      --ease: cubic-bezier(.2,.8,.2,1);
      --dur-fast: 120ms;
      --dur: 180ms;
      --dur-slow: 320ms;

      /* Layout */
      --maxw: 1200px;
    }

    /* Light mode fallback (optional) */
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f8fb;
        --surface: rgba(15, 23, 42, 0.04);
        --surface-2: rgba(15, 23, 42, 0.06);
        --card: rgba(255,255,255,0.85);
        --card-2: rgba(255,255,255,0.95);
        --border: rgba(15, 23, 42, 0.10);
        --border-strong: rgba(15, 23, 42, 0.16);
        --text: rgba(15, 23, 42, 0.92);
        --text-muted: rgba(15, 23, 42, 0.70);
        --text-faint: rgba(15, 23, 42, 0.55);
        --shadow-sm: 0 6px 18px rgba(15,23,42,.10);
        --shadow-md: 0 14px 44px rgba(15,23,42,.14);
      }
    }

    /* =========================
       Base styles
       ========================= */
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font-sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(110,168,255,.22), transparent 50%),
        radial-gradient(1000px 700px at 90% 10%, rgba(102,227,196,.14), transparent 55%),
        radial-gradient(900px 600px at 50% 100%, rgba(192,132,252,.12), transparent 55%),
        var(--bg);
      line-height:1.5;
    }

    a{ color:inherit; text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .container{
      max-width:var(--maxw);
      padding: var(--space-8) var(--space-4);
      margin: 0 auto;
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:var(--space-4);
      margin-bottom: var(--space-6);
    }

    .brand{
      display:flex;
      gap:var(--space-3);
      align-items:center;
      min-width: 240px;
    }

    .logo{
      width:40px;height:40px;border-radius:12px;
      background: linear-gradient(135deg, rgba(110,168,255,.95), rgba(102,227,196,.85));
      box-shadow: var(--shadow-sm);
      border:1px solid rgba(255,255,255,.18);
    }

    .title h1{
      margin:0;
      font-size: 22px;
      letter-spacing: .2px;
      font-weight: 700;
    }
    .title p{
      margin:2px 0 0;
      color:var(--text-muted);
      font-size: 13px;
    }

    .actions{
      display:flex;
      gap:var(--space-2);
      align-items:center;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .kbd{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-muted);
      font-size: 12px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap: var(--space-4);
    }

    @media (max-width: 960px){
      .grid{ grid-template-columns: 1fr; }
      .actions{ justify-content:flex-start; }
    }

    /* =========================
       Components
       ========================= */
    .card{
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,0.06));
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      overflow:hidden;
    }

    .card-hd{
      padding: var(--space-4);
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: var(--space-4);
      background: rgba(255,255,255,0.03);
    }

    .card-hd h2{
      margin:0;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: .2px;
    }

    .card-hd .sub{
      margin:0;
      color:var(--text-muted);
      font-size: 12px;
    }

    .card-bd{
      padding: var(--space-4);
    }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 600;
      font-size: 13px;
      cursor:pointer;
      transition: transform var(--dur-fast) var(--ease), background var(--dur) var(--ease), border-color var(--dur) var(--ease), opacity var(--dur) var(--ease);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;
    }
    .btn:hover{ background: var(--surface-2); border-color: var(--border-strong); }
    .btn:active{ transform: translateY(1px); }
    .btn:focus{ outline:none; box-shadow: var(--focus); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    .btn-primary{
      background: rgba(110,168,255,.22);
      border-color: rgba(110,168,255,.38);
    }
    .btn-primary:hover{
      background: rgba(110,168,255,.30);
      border-color: rgba(110,168,255,.55);
    }

    .btn-ghost{
      background: transparent;
    }

    .input, .select, .textarea{
      width:100%;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      transition: border-color var(--dur) var(--ease), box-shadow var(--dur) var(--ease), background var(--dur) var(--ease);
    }
    .input:focus, .select:focus, .textarea:focus{
      outline:none;
      box-shadow: var(--focus);
      border-color: rgba(110,168,255,.55);
      background: rgba(0,0,0,0.24);
    }
    .textarea{ min-height: 160px; resize: vertical; line-height: 1.6; }

    .row{
      display:flex;
      gap: var(--space-3);
      align-items:center;
      flex-wrap:wrap;
    }
    .row > *{ flex: 1 1 auto; }

    .muted{ color: var(--text-muted); }
    .faint{ color: var(--text-faint); }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid var(--border);
      background: var(--surface);
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      white-space:nowrap;
    }
    .badge.dot::before{
      content:"";
      width: 8px;
      height: 8px;
      border-radius: 99px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(102,227,196,.18);
    }
    .badge.warn::before{ background: var(--warning); box-shadow: 0 0 0 3px rgba(255,204,102,.18); }
    .badge.danger::before{ background: var(--destructive); box-shadow: 0 0 0 3px rgba(255,107,107,.18); }

    .kpi-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-3);
    }
    @media (max-width: 960px){
      .kpi-grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 520px){
      .kpi-grid{ grid-template-columns: 1fr; }
    }

    .kpi{
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border-radius: var(--radius-md);
      padding: var(--space-4);
      min-height: 88px;
    }
    .kpi .label{ font-size: 12px; color: var(--text-muted); margin:0; }
    .kpi .value{ font-size: 24px; font-weight: 800; margin: 6px 0 0; letter-spacing:.2px; }
    .kpi .meta{ font-size: 12px; color: var(--text-faint); margin: 6px 0 0; }

    /* Tabs */
    .tabs{
      display:flex;
      gap: var(--space-2);
      padding: var(--space-2);
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.16);
      border-radius: 14px;
      overflow:auto;
    }
    .tab{
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-muted);
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 12px;
      cursor:pointer;
      white-space:nowrap;
      transition: background var(--dur) var(--ease), color var(--dur) var(--ease), border-color var(--dur) var(--ease);
    }
    .tab:hover{ background: rgba(255,255,255,0.06); color: var(--text); }
    .tab[aria-selected="true"]{
      background: rgba(110,168,255,.22);
      color: var(--text);
      border-color: rgba(110,168,255,.38);
    }

    /* Table */
    .table-wrap{
      overflow:auto;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: rgba(0,0,0,0.14);
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 820px;
    }
    th, td{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      font-size: 13px;
      vertical-align: top;
    }
    th{
      position: sticky;
      top:0;
      background: rgba(10,14,28,0.78);
      backdrop-filter: blur(10px);
      text-align:left;
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 700;
      letter-spacing:.2px;
      border-bottom: 1px solid var(--border);
      z-index: 1;
    }
    tr:hover td{ background: rgba(255,255,255,0.04); }

    .linkbtn{
      background: transparent;
      border:none;
      padding:0;
      color: var(--primary-2);
      font-weight: 700;
      cursor:pointer;
      text-align:left;
    }
    .linkbtn:hover{ text-decoration: underline; }

    /* Skeleton / loading */
    .loading{
      display:flex;
      align-items:center;
      gap: 10px;
      color: var(--text-muted);
      font-size: 13px;
    }
    .spinner{
      width: 18px;
      height: 18px;
      border-radius: 99px;
      border: 2px solid rgba(255,255,255,0.18);
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .progress{
      height: 8px;
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.16);
    }
    .progress > div{
      height:100%;
      width: 18%;
      background: linear-gradient(90deg, rgba(110,168,255,.25), rgba(102,227,196,.24));
      animation: slide 1.2s var(--ease) infinite;
    }
    @keyframes slide{
      0%{ transform: translateX(-40%); width: 18%; opacity:.6; }
      50%{ transform: translateX(260%); width: 28%; opacity: 1;}
      100%{ transform: translateX(540%); width: 18%; opacity:.6; }
    }

    /* Toast */
    .toasts{
      position: fixed;
      right: 16px;
      bottom: 16px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      z-index: 60;
      max-width: 420px;
    }
    .toast{
      border:1px solid var(--border);
      background: rgba(10,14,28,0.78);
      backdrop-filter: blur(14px);
      border-radius: 14px;
      padding: 12px 12px;
      box-shadow: var(--shadow-md);
      display:flex;
      gap: 10px;
      align-items:flex-start;
      animation: toastIn var(--dur-slow) var(--ease) both;
    }
    @keyframes toastIn{
      from{ transform: translateY(8px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }
    .toast .ico{
      width: 20px; height: 20px; border-radius: 8px;
      background: rgba(102,227,196,.18);
      border: 1px solid rgba(102,227,196,.32);
      margin-top: 1px;
    }
    .toast.warn .ico{
      background: rgba(255,204,102,.18);
      border-color: rgba(255,204,102,.34);
    }
    .toast.danger .ico{
      background: rgba(255,107,107,.18);
      border-color: rgba(255,107,107,.34);
    }
    .toast h4{
      margin:0;
      font-size: 13px;
      font-weight: 800;
    }
    .toast p{
      margin: 2px 0 0;
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Modal */
    dialog{
      border: none;
      padding:0;
      border-radius: 18px;
      width: min(980px, calc(100vw - 24px));
      background: rgba(10,14,28,0.80);
      backdrop-filter: blur(14px);
      color: var(--text);
      box-shadow: var(--shadow-md);
    }
    dialog::backdrop{
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(2px);
    }
    .modal-hd{
      padding: var(--space-4);
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: var(--space-3);
    }
    .modal-hd h3{
      margin:0;
      font-size: 16px;
      font-weight: 800;
    }
    .modal-hd .meta{
      margin: 6px 0 0;
      color: var(--text-muted);
      font-size: 12px;
    }
    .modal-bd{
      padding: var(--space-4);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
    }
    @media (max-width: 860px){
      .modal-bd{ grid-template-columns: 1fr; }
    }
    .modal-ft{
      padding: var(--space-4);
      border-top: 1px solid var(--border);
      display:flex;
      justify-content:flex-end;
      gap: var(--space-2);
    }
    .kv{
      border:1px solid var(--border);
      background: rgba(0,0,0,0.14);
      border-radius: 14px;
      overflow:hidden;
    }
    .kv .kv-hd{
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 800;
      color: var(--text-muted);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.03);
    }
    .kv .kv-bd{
      padding: 12px;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Infinite scroll hint */
    .sentinel{
      height: 1px;
    }

    /* Footer */
    .footer{
      margin-top: var(--space-8);
      color: var(--text-faint);
      font-size: 12px;
      display:flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: var(--space-2);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="brand" aria-label="ブランド">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>愛媛ケーブルテレビ｜VOCダッシュボード（デモ）</h1>
          <p>コールセンター文字起こし由来の構造化要約（ダミーデータ）を可視化</p>
        </div>
      </div>

      <div class="actions">
        <span class="kbd" title="データは ./data/voc.json を読み込みます">data/voc.json</span>
        <button class="btn btn-ghost" id="btnReload" type="button" title="再読み込み">再読み込み</button>
        <button class="btn btn-primary" id="btnOpenJson" type="button" title="voc.json を別タブで開く">voc.json を開く</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: main -->
      <section class="card" aria-label="メイン">
        <div class="card-hd">
          <div>
            <h2>サマリ</h2>
            <p class="sub" id="subtitle">読み込み準備中…</p>
          </div>
          <div class="row" style="justify-content:flex-end;gap:8px;max-width: 520px;">
            <input class="input" id="q" type="search" placeholder="検索（オペレーター名／入電目的／要約のキーワード）" aria-label="検索" />
            <select class="select" id="purpose" aria-label="入電目的">
              <option value="">入電目的(大分類)：すべて</option>
            </select>
          </div>
        </div>

        <div class="card-bd">
          <div id="loadingBox">
            <div class="loading" aria-live="polite">
              <div class="spinner" aria-hidden="true"></div>
              <div style="flex:1">
                <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
                  <div>データを読み込み中…</div>
                  <div class="faint" id="loadingHint">少し待ってください</div>
                </div>
                <div class="progress" style="margin-top:10px"><div></div></div>
              </div>
            </div>
          </div>

          <div id="mainContent" style="display:none">
            <div class="kpi-grid" aria-label="KPI">
              <div class="kpi">
                <p class="label">総件数</p>
                <p class="value" id="kpiTotal">-</p>
                <p class="meta" id="kpiTotalMeta">-</p>
              </div>
              <div class="kpi">
                <p class="label">期間（通話日時）</p>
                <p class="value" id="kpiRange">-</p>
                <p class="meta" id="kpiRangeMeta">-</p>
              </div>
              <div class="kpi">
                <p class="label">平均スコア（Soft / Hard基本 / Hard専門 / 判断提案）</p>
                <p class="value" id="kpiScore">-</p>
                <p class="meta" id="kpiScoreMeta">-</p>
              </div>
              <div class="kpi">
                <p class="label">解約リスク（High）</p>
                <p class="value" id="kpiChurnHigh">-</p>
                <p class="meta" id="kpiChurnHighMeta">-</p>
              </div>
            </div>

            <div style="height: var(--space-4)"></div>

            <div class="tabs" role="tablist" aria-label="ビュー切替">
              <button class="tab" id="tabOverview" role="tab" aria-selected="true" aria-controls="panelOverview" type="button">Overview</button>
              <button class="tab" id="tabByPurpose" role="tab" aria-selected="false" aria-controls="panelByPurpose" type="button">入電目的</button>
              <button class="tab" id="tabOperators" role="tab" aria-selected="false" aria-controls="panelOperators" type="button">オペレーター</button>
              <button class="tab" id="tabRecords" role="tab" aria-selected="false" aria-controls="panelRecords" type="button">VOC一覧</button>
            </div>

            <div style="height: var(--space-4)"></div>

            <!-- Panels -->
            <div id="panelOverview" role="tabpanel" aria-labelledby="tabOverview">
              <div class="row" style="gap: var(--space-4); align-items: stretch;">
                <div class="card" style="flex:1">
                  <div class="card-hd">
                    <div>
                      <h2>入電目的(大分類)（件数）</h2>
                      <p class="sub">フィルタ適用後の件数</p>
                    </div>
                    <span class="badge dot" id="badgeFilter">フィルタ: なし</span>
                  </div>
                  <div class="card-bd">
                    <canvas id="chartPurpose" height="120" aria-label="入電目的チャート"></canvas>
                  </div>
                </div>

                <div class="card" style="flex:1">
                  <div class="card-hd">
                    <div>
                      <h2>解約リスク分布</h2>
                      <p class="sub">Low / Medium / High / 未設定</p>
                    </div>
                    <span class="badge" id="badgeChurn">集計</span>
                  </div>
                  <div class="card-bd">
                    <canvas id="chartChurn" height="120" aria-label="解約リスクチャート"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <div id="panelByPurpose" role="tabpanel" aria-labelledby="tabByPurpose" style="display:none">
              <div class="card">
                <div class="card-hd">
                  <div>
                    <h2>入電目的別（上位）</h2>
                    <p class="sub">クリックでフィルタに反映</p>
                  </div>
                  <span class="badge">Table</span>
                </div>
                <div class="card-bd">
                  <div class="table-wrap">
                    <table aria-label="入電目的テーブル">
                      <thead>
                        <tr>
                          <th style="width:28%">入電目的(大分類)</th>
                          <th style="width:10%">件数</th>
                          <th style="width:16%">High比率</th>
                          <th style="width:16%">平均スコア</th>
                          <th>よくあるTrigger（例）</th>
                        </tr>
                      </thead>
                      <tbody id="tbodyPurpose"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div id="panelOperators" role="tabpanel" aria-labelledby="tabOperators" style="display:none">
              <div class="card">
                <div class="card-hd">
                  <div>
                    <h2>オペレーター別（上位）</h2>
                    <p class="sub">件数・平均スコア・High比率</p>
                  </div>
                  <span class="badge">Table</span>
                </div>
                <div class="card-bd">
                  <div class="table-wrap">
                    <table aria-label="オペレーターテーブル">
                      <thead>
                        <tr>
                          <th style="width:24%">オペレーター名</th>
                          <th style="width:10%">件数</th>
                          <th style="width:14%">平均Soft</th>
                          <th style="width:14%">平均Hard基本</th>
                          <th style="width:14%">平均Hard専門</th>
                          <th style="width:14%">平均判断提案</th>
                          <th style="width:10%">High比率</th>
                        </tr>
                      </thead>
                      <tbody id="tbodyOperators"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div id="panelRecords" role="tabpanel" aria-labelledby="tabRecords" style="display:none">
              <div class="card">
                <div class="card-hd">
                  <div>
                    <h2>VOC一覧</h2>
                    <p class="sub">検索・フィルタ後の結果（クリックで詳細）</p>
                  </div>
                  <div class="row" style="justify-content:flex-end;gap:8px;max-width: 520px;">
                    <select class="select" id="risk" aria-label="解約リスク">
                      <option value="">解約リスク：すべて</option>
                      <option value="low">Low</option>
                      <option value="medium">Medium</option>
                      <option value="high">High</option>
                      <option value="null">未設定</option>
                    </select>
                    <select class="select" id="sort" aria-label="並び替え">
                      <option value="date_desc">新しい順</option>
                      <option value="date_asc">古い順</option>
                      <option value="score_desc">スコア高い順</option>
                      <option value="score_asc">スコア低い順</option>
                    </select>
                  </div>
                </div>
                <div class="card-bd">
                  <div class="table-wrap">
                    <table aria-label="VOC一覧テーブル">
                      <thead>
                        <tr>
                          <th style="width:16%">通話日時</th>
                          <th style="width:14%">オペレーター名</th>
                          <th style="width:16%">入電目的</th>
                          <th style="width:10%">解約リスク</th>
                          <th style="width:10%">平均スコア</th>
                          <th>会話要約</th>
                        </tr>
                      </thead>
                      <tbody id="tbodyRecords"></tbody>
                    </table>
                  </div>

                  <div style="height: var(--space-3)"></div>
                  <div class="row" style="justify-content:space-between;align-items:center;">
                    <div class="muted" id="pagerInfo">-</div>
                    <div class="row" style="justify-content:flex-end;gap:8px;flex: 0 0 auto;">
                      <button class="btn" id="btnMore" type="button">さらに表示</button>
                      <span class="kbd" id="hintInfinite">無限スクロール対応</span>
                    </div>
                  </div>

                  <div class="sentinel" id="sentinel" aria-hidden="true"></div>
                </div>
              </div>
            </div>

          </div><!-- /mainContent -->
        </div>
      </section>

      <!-- RIGHT: side -->
      <aside class="card" aria-label="サイド">
        <div class="card-hd">
          <div>
            <h2>クイック操作</h2>
            <p class="sub">デモ用ユーティリティ</p>
          </div>
          <span class="badge">Tools</span>
        </div>
        <div class="card-bd">
          <div class="row" style="gap: var(--space-2)">
            <button class="btn btn-primary" id="btnDemoToast" type="button">トースト表示</button>
            <button class="btn" id="btnReset" type="button">フィルタ解除</button>
          </div>

          <div style="height: var(--space-4)"></div>

          <div class="kv">
            <div class="kv-hd">データ読み込み</div>
            <div class="kv-bd">
              <div class="muted">読み込み元</div>
              <div style="margin-top:6px"><code>./data/voc.json</code></div>
              <div style="margin-top:10px" class="muted">ステータス</div>
              <div style="margin-top:6px" id="statusText">未読み込み</div>
              <div style="margin-top:10px" class="muted">注意</div>
              <div style="margin-top:6px" class="faint">個人情報は含めない前提のダミーデータで動作します。</div>
            </div>
          </div>

          <div style="height: var(--space-4)"></div>

          <div class="kv">
            <div class="kv-hd">構造化項目（例）</div>
            <div class="kv-bd faint">
              通話日時 / オペレーター名 / 顧客属性(推定) / 契約状況(推測) / 入電目的(大分類) /
              Trigger / Action / ライフイベント・予兆 / 解約リスク判定 / 各評価点数と根拠 / 会話要約 / 会話全文(整形済)
            </div>
          </div>

        </div>
      </aside>
    </div>

    <div class="footer">
      <div>© Demo — Ehime Cable TV / 愛媛ケーブルテレビ（想定）</div>
      <div class="faint">GitHub Pages で配信・ローカルでデータ生成（PowerShell）</div>
    </div>
  </div>

  <!-- Modal -->
  <dialog id="dlg">
    <div class="modal-hd">
      <div>
        <h3 id="dlgTitle">VOC詳細</h3>
        <div class="meta" id="dlgMeta">-</div>
      </div>
      <button class="btn btn-ghost" id="btnClose" type="button" aria-label="閉じる">閉じる</button>
    </div>
    <div class="modal-bd">
      <div class="kv">
        <div class="kv-hd">要約（会話要約）</div>
        <div class="kv-bd" id="dlgSummary">-</div>
      </div>
      <div class="kv">
        <div class="kv-hd">分類・リスク</div>
        <div class="kv-bd" id="dlgClass">-</div>
      </div>
      <div class="kv">
        <div class="kv-hd">Trigger / Action</div>
        <div class="kv-bd" id="dlgTA">-</div>
      </div>
      <div class="kv">
        <div class="kv-hd">評価（Soft / Hard基本 / Hard専門 / 判断提案）</div>
        <div class="kv-bd" id="dlgScores">-</div>
      </div>
      <div class="kv" style="grid-column: 1 / -1;">
        <div class="kv-hd">会話全文(整形済)</div>
        <div class="kv-bd" id="dlgFull">-</div>
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn" id="btnCopyJson" type="button">JSONをコピー</button>
      <button class="btn btn-primary" id="btnClose2" type="button">閉じる</button>
    </div>
  </dialog>

  <!-- Toasts -->
  <div class="toasts" id="toasts" aria-live="polite" aria-relevant="additions"></div>

  <script>
    // =========================
    // Utilities
    // =========================
    const $ = (sel) => document.querySelector(sel);

    function toast(title, message, kind="ok", timeout=3800){
      const wrap = $("#toasts");
      const t = document.createElement("div");
      t.className = "toast" + (kind==="warn" ? " warn" : kind==="danger" ? " danger" : "");
      const ico = document.createElement("div");
      ico.className = "ico";
      const box = document.createElement("div");
      const h = document.createElement("h4");
      h.textContent = title;
      const p = document.createElement("p");
      p.textContent = message;
      box.appendChild(h); box.appendChild(p);
      t.appendChild(ico); t.appendChild(box);
      wrap.appendChild(t);
      setTimeout(()=>{ t.style.opacity = "0"; t.style.transform="translateY(6px)"; t.style.transition="opacity 200ms ease, transform 200ms ease"; }, timeout);
      setTimeout(()=>{ t.remove(); }, timeout + 260);
    }

    function safeStr(v){
      if(v === null || v === undefined) return "";
      return String(v);
    }

    function normRisk(v){
      const s = safeStr(v).trim().toLowerCase();
      if(!s) return null;
      if(s.includes("high")) return "high";
      if(s.includes("medium")) return "medium";
      if(s.includes("low")) return "low";
      // JP fallback
      if(s.includes("高")) return "high";
      if(s.includes("中")) return "medium";
      if(s.includes("低")) return "low";
      return s;
    }

    function parseDateLoose(s){
      // supports: 2023/10/6, 2023-10-06, 2023年10月6日, etc.
      if(!s) return null;
      const t = String(s).trim();
      const m1 = t.match(/(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
      if(m1){
        const y=+m1[1], mo=+m1[2], d=+m1[3];
        const dt = new Date(y, mo-1, d);
        return isNaN(dt) ? null : dt;
      }
      const m2 = t.match(/(\d{4})年(\d{1,2})月(\d{1,2})日/);
      if(m2){
        const y=+m2[1], mo=+m2[2], d=+m2[3];
        const dt = new Date(y, mo-1, d);
        return isNaN(dt) ? null : dt;
      }
      const dt = new Date(t);
      return isNaN(dt) ? null : dt;
    }

    function fmtDate(dt){
      if(!dt) return "—";
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const d = String(dt.getDate()).padStart(2,"0");
      return `${y}/${m}/${d}`;
    }

    function avg(arr){
      const xs = arr.filter(x => Number.isFinite(x));
      if(xs.length===0) return null;
      return xs.reduce((a,b)=>a+b,0)/xs.length;
    }

    function clamp01(n){
      if(!Number.isFinite(n)) return null;
      return Math.max(0, Math.min(1, n));
    }

    function numOrNull(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function scoreOf(r){
      const soft = numOrNull(r["評価_Soft_点数"]);
      const hb   = numOrNull(r["評価_Hard基本_点数"]);
      const hp   = numOrNull(r["評価_Hard専門_点数"]);
      const prop = numOrNull(r["評価_判断提案_点数"]);
      const a = avg([soft,hb,hp,prop]);
      return a;
    }

    function getPurpose(r){
      return safeStr(r["入電目的(大分類)"]).trim() || "未設定";
    }

    function getOperator(r){
      return safeStr(r["オペレーター名"]).trim() || "（未設定）";
    }

    function getSummary(r){
      return safeStr(r["会話要約"]).trim() || safeStr(r["具体的課題(Trigger)"]).trim() || "—";
    }

    function getTrigger(r){
      return safeStr(r["具体的課題(Trigger)"]).trim() || "—";
    }

    function getAction(r){
      return safeStr(r["解決プロセス(Action)"]).trim() || "—";
    }

    function getRisk(r){
      const v = r["解約リスク判定"];
      const nr = normRisk(v);
      return nr || "null";
    }

    // =========================
    // State
    // =========================
    const DATA_URL = "./data/voc.json";

    let ALL = [];
    let FILTERED = [];
    let pageSize = 60;
    let page = 1;

    let chartPurpose = null;
    let chartChurn = null;

    const purposeOrder = [
      "障害/不具合",
      "機器/設定サポート",
      "料金/請求",
      "契約変更",
      "解約",
      "引越し",
      "工事/訪問手配",
      "営業案内",
      "サービス案内",
      "その他",
      "未設定"
    ];

    // =========================
    // Charts
    // =========================
    function destroyCharts(){
      if(chartPurpose){ chartPurpose.destroy(); chartPurpose=null; }
      if(chartChurn){ chartChurn.destroy(); chartChurn=null; }
    }

    function cssVar(name){
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    function buildPurposeChart(rows){
      const counts = new Map();
      for(const r of rows){
        const p = getPurpose(r);
        counts.set(p, (counts.get(p)||0)+1);
      }
      const labels = [];
      const values = [];
      const ordered = [...purposeOrder];
      for(const [k] of counts){ if(!ordered.includes(k)) ordered.push(k); }
      for(const k of ordered){
        if(counts.has(k)){
          labels.push(k);
          values.push(counts.get(k));
        }
      }

      const ctx = $("#chartPurpose");
      chartPurpose = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "件数",
            data: values,
            borderWidth: 1,
            backgroundColor: [
              cssVar("--chart-1"), cssVar("--chart-2"), cssVar("--chart-3"),
              cssVar("--chart-4"), cssVar("--chart-5"), cssVar("--chart-2"),
              cssVar("--chart-1"), cssVar("--chart-3"), cssVar("--chart-4"),
              cssVar("--chart-5"), cssVar("--chart-1")
            ].map(c => c + "33"),
            borderColor: cssVar("--border-strong")
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display:false },
            tooltip: {
              callbacks:{
                label: (c) => ` ${c.raw} 件`
              }
            }
          },
          scales: {
            x: {
              ticks: { color: cssVar("--text-muted"), maxRotation: 0, autoSkip: true },
              grid: { color: "rgba(255,255,255,0.06)" }
            },
            y: {
              ticks: { color: cssVar("--text-muted") },
              grid: { color: "rgba(255,255,255,0.06)" }
            }
          }
        }
      });
    }

    function buildChurnChart(rows){
      const buckets = { low:0, medium:0, high:0, null:0 };
      for(const r of rows){
        const k = getRisk(r);
        buckets[k] = (buckets[k]||0)+1;
      }
      const labels = ["Low","Medium","High","未設定"];
      const values = [buckets.low||0, buckets.medium||0, buckets.high||0, buckets.null||0];
      const ctx = $("#chartChurn");
      chartChurn = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: [
              cssVar("--success") + "44",
              cssVar("--warning") + "44",
              cssVar("--destructive") + "44",
              cssVar("--secondary") + "33"
            ],
            borderColor: cssVar("--border"),
            borderWidth: 1
          }]
        },
        options: {
          responsive:true,
          plugins:{
            legend:{ position:"bottom", labels:{ color: cssVar("--text-muted") } }
          }
        }
      });

      $("#badgeChurn").textContent = `Low ${values[0]} / Medium ${values[1]} / High ${values[2]}`;
    }

    // =========================
    // Rendering
    // =========================
    function setSubtitle(text){
      $("#subtitle").textContent = text;
    }

    function setStatus(text){
      $("#statusText").textContent = text;
    }

    function renderKpis(rows){
      $("#kpiTotal").textContent = rows.length.toLocaleString("ja-JP");
      $("#kpiTotalMeta").textContent = `フィルタ後 / 全 ${ALL.length.toLocaleString("ja-JP")} 件`;

      const dates = rows.map(r => parseDateLoose(r["通話日時"])).filter(Boolean).sort((a,b)=>a-b);
      const minD = dates[0] || null;
      const maxD = dates[dates.length-1] || null;
      $("#kpiRange").textContent = (minD && maxD) ? `${fmtDate(minD)}〜${fmtDate(maxD)}` : "—";
      $("#kpiRangeMeta").textContent = (minD && maxD) ? `期間内 ${dates.length.toLocaleString("ja-JP")} 件` : "通話日時が未設定のデータがあります";

      const scores = rows.map(scoreOf).filter(x => Number.isFinite(x));
      const sAvg = avg(scores);
      $("#kpiScore").textContent = sAvg ? sAvg.toFixed(2) : "—";
      $("#kpiScoreMeta").textContent = sAvg ? "（1〜5の平均）" : "評価点数が未設定のデータがあります";

      const churnHigh = rows.filter(r => getRisk(r)==="high").length;
      const ratio = rows.length ? clamp01(churnHigh / rows.length) : 0;
      $("#kpiChurnHigh").textContent = churnHigh.toLocaleString("ja-JP");
      $("#kpiChurnHighMeta").textContent = `比率 ${(ratio*100).toFixed(1)}%`;
    }

    function renderPurposeSelect(){
      const sel = $("#purpose");
      const current = sel.value;
      const set = new Set(ALL.map(getPurpose));
      const list = [];
      for(const p of purposeOrder){ if(set.has(p)) list.push(p); }
      for(const p of [...set].sort()){ if(!list.includes(p)) list.push(p); }

      sel.innerHTML = `<option value="">入電目的(大分類)：すべて</option>` + list.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
      sel.value = current || "";
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    function applyFilters(){
      const q = $("#q").value.trim().toLowerCase();
      const p = $("#purpose").value;
      const r = $("#risk").value;

      FILTERED = ALL.filter(row=>{
        if(p && getPurpose(row) !== p) return false;

        if(r){
          const rr = getRisk(row);
          if(r === "null"){
            if(rr !== "null") return false;
          }else{
            if(rr !== r) return false;
          }
        }

        if(q){
          const hay = [
            getOperator(row),
            getPurpose(row),
            safeStr(row["顧客属性(推定)"]),
            safeStr(row["契約状況(推測)"]),
            safeStr(row["具体的課題(Trigger)"]),
            safeStr(row["解決プロセス(Action)"]),
            safeStr(row["会話要約"])
          ].join(" ").toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });

      page = 1;
      updateAll();
    }

    function sortRows(rows){
      const mode = $("#sort").value;
      const copy = [...rows];

      const dateKey = (row)=>{
        const dt = parseDateLoose(row["通話日時"]);
        return dt ? dt.getTime() : -Infinity;
      };
      const scoreKey = (row)=>{
        const s = scoreOf(row);
        return Number.isFinite(s) ? s : -Infinity;
      };

      if(mode === "date_asc") copy.sort((a,b)=>dateKey(a)-dateKey(b));
      else if(mode === "date_desc") copy.sort((a,b)=>dateKey(b)-dateKey(a));
      else if(mode === "score_asc") copy.sort((a,b)=>scoreKey(a)-scoreKey(b));
      else if(mode === "score_desc") copy.sort((a,b)=>scoreKey(b)-scoreKey(a));

      return copy;
    }

    function renderPurposeTable(rows){
      const by = new Map();
      for(const r of rows){
        const p = getPurpose(r);
        if(!by.has(p)) by.set(p, []);
        by.get(p).push(r);
      }

      const items = [];
      for(const [p, list] of by.entries()){
        const high = list.filter(x=>getRisk(x)==="high").length;
        const highRatio = list.length ? (high/list.length) : 0;
        const s = avg(list.map(scoreOf));
        const triggerExample = list.map(getTrigger).find(t=>t && t!=="—") || "—";
        items.push({ p, n:list.length, highRatio, s, triggerExample });
      }

      items.sort((a,b)=> b.n - a.n);

      const tbody = $("#tbodyPurpose");
      tbody.innerHTML = items.map(it=>{
        const hi = (it.highRatio*100).toFixed(1) + "%";
        const sc = (it.s ? it.s.toFixed(2) : "—");
        return `
          <tr>
            <td><button class="linkbtn" data-purpose="${escapeHtml(it.p)}">${escapeHtml(it.p)}</button></td>
            <td>${it.n.toLocaleString("ja-JP")}</td>
            <td>${hi}</td>
            <td>${sc}</td>
            <td class="faint">${escapeHtml(it.triggerExample)}</td>
          </tr>
        `;
      }).join("");

      tbody.querySelectorAll("button[data-purpose]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          $("#purpose").value = btn.getAttribute("data-purpose");
          toast("フィルタ", `入電目的(大分類) = ${$("#purpose").value}`, "ok");
          applyFilters();
        });
      });
    }

    function renderOperatorTable(rows){
      const by = new Map();
      for(const r of rows){
        const op = getOperator(r);
        if(!by.has(op)) by.set(op, []);
        by.get(op).push(r);
      }

      const items = [];
      for(const [op, list] of by.entries()){
        const high = list.filter(x=>getRisk(x)==="high").length;
        const highRatio = list.length ? (high/list.length) : 0;

        const soft = avg(list.map(x=>numOrNull(x["評価_Soft_点数"])));
        const hb   = avg(list.map(x=>numOrNull(x["評価_Hard基本_点数"])));
        const hp   = avg(list.map(x=>numOrNull(x["評価_Hard専門_点数"])));
        const prop = avg(list.map(x=>numOrNull(x["評価_判断提案_点数"])));

        items.push({ op, n:list.length, soft, hb, hp, prop, highRatio });
      }

      items.sort((a,b)=> b.n - a.n);

      const tbody = $("#tbodyOperators");
      tbody.innerHTML = items.map(it=>{
        const f = (x)=> Number.isFinite(x) ? x.toFixed(2) : "—";
        return `
          <tr>
            <td>${escapeHtml(it.op)}</td>
            <td>${it.n.toLocaleString("ja-JP")}</td>
            <td>${f(it.soft)}</td>
            <td>${f(it.hb)}</td>
            <td>${f(it.hp)}</td>
            <td>${f(it.prop)}</td>
            <td>${(it.highRatio*100).toFixed(1)}%</td>
          </tr>
        `;
      }).join("");
    }

    function renderRecordsTable(rows){
      const sorted = sortRows(rows);
      const shown = sorted.slice(0, pageSize * page);

      $("#pagerInfo").textContent = `${shown.length.toLocaleString("ja-JP")} / ${sorted.length.toLocaleString("ja-JP")} 件を表示`;

      const tbody = $("#tbodyRecords");
      tbody.innerHTML = shown.map((r, idx)=>{
        const dt = parseDateLoose(r["通話日時"]);
        const date = fmtDate(dt);
        const op = getOperator(r);
        const purpose = getPurpose(r);
        const risk = getRisk(r);
        const score = scoreOf(r);
        const scoreText = Number.isFinite(score) ? score.toFixed(2) : "—";

        const riskBadge = risk==="high"
          ? `<span class="badge danger dot">High</span>`
          : risk==="medium"
            ? `<span class="badge warn dot">Medium</span>`
            : risk==="low"
              ? `<span class="badge dot">Low</span>`
              : `<span class="badge">未設定</span>`;

        return `
          <tr>
            <td>${escapeHtml(date)}</td>
            <td>${escapeHtml(op)}</td>
            <td>${escapeHtml(purpose)}</td>
            <td>${riskBadge}</td>
            <td>${escapeHtml(scoreText)}</td>
            <td><button class="linkbtn" data-idx="${idx}">${escapeHtml(getSummary(r))}</button></td>
          </tr>
        `;
      }).join("");

      // Bind detail open
      tbody.querySelectorAll("button[data-idx]").forEach((btn)=>{
        btn.addEventListener("click", ()=>{
          const idx = Number(btn.getAttribute("data-idx"));
          // Find record by summary text match within currently shown set
          // More reliable: store a stable id if your JSON has one.
          const rec = shown[idx];
          if(rec) openDialog(rec);
        });
      });

      // Infinite scroll sentinel
      if(shown.length >= sorted.length){
        $("#btnMore").disabled = true;
        $("#btnMore").textContent = "すべて表示済み";
      }else{
        $("#btnMore").disabled = false;
        $("#btnMore").textContent = "さらに表示";
      }
    }

    function openDialog(r){
      const dt = parseDateLoose(r["通話日時"]);
      const date = fmtDate(dt);
      const op = getOperator(r);
      const purpose = getPurpose(r);
      const risk = getRisk(r);

      $("#dlgTitle").textContent = `${purpose}｜${op}`;
      $("#dlgMeta").textContent = `通話日時: ${date} / 解約リスク: ${risk==="null" ? "未設定" : risk.toUpperCase()}`;

      $("#dlgSummary").textContent = getSummary(r);

      const churnDetail = safeStr(r["解約リスク判定_詳細"]).trim() || "—";
      const attr = safeStr(r["顧客属性(推定)"]).trim() || "—";
      const contract = safeStr(r["契約状況(推測)"]).trim() || "—";
      $("#dlgClass").textContent =
        `顧客属性(推定): ${attr}\n契約状況(推測): ${contract}\n入電目的(大分類): ${purpose}\n解約リスク判定_詳細: ${churnDetail}`;

      $("#dlgTA").textContent = `Trigger:\n${getTrigger(r)}\n\nAction:\n${getAction(r)}`;

      const soft = safeStr(r["評価_Soft_点数"]) || "—";
      const hb   = safeStr(r["評価_Hard基本_点数"]) || "—";
      const hp   = safeStr(r["評価_Hard専門_点数"]) || "—";
      const prop = safeStr(r["評価_判断提案_点数"]) || "—";

      const softR = safeStr(r["評価_Soft_根拠"]) || "—";
      const hbR   = safeStr(r["評価_Hard基本_根拠"]) || "—";
      const hpR   = safeStr(r["評価_Hard専門_根拠"]) || "—";
      const propR = safeStr(r["評価_判断提案_根拠"]) || "—";

      $("#dlgScores").textContent =
        `Soft: ${soft}\n  根拠: ${softR}\n` +
        `Hard基本: ${hb}\n  根拠: ${hbR}\n` +
        `Hard専門: ${hp}\n  根拠: ${hpR}\n` +
        `判断提案: ${prop}\n  根拠: ${propR}\n`;

      $("#dlgFull").textContent = safeStr(r["会話全文(整形済)"]).trim() || "—";

      const dlg = $("#dlg");
      if(typeof dlg.showModal === "function"){
        dlg.showModal();
      }else{
        // Fallback (older browsers): show as block
        dlg.setAttribute("open", "open");
      }

      $("#btnCopyJson").onclick = async ()=>{
        const text = JSON.stringify(r, null, 2);
        try{
          await navigator.clipboard.writeText(text);
          toast("コピー", "JSONをクリップボードにコピーしました", "ok");
        }catch(e){
          toast("コピー失敗", "ブラウザの権限設定によりコピーできませんでした", "warn");
        }
      };
    }

    function closeDialog(){
      const dlg = $("#dlg");
      try{ dlg.close(); }catch(e){ dlg.removeAttribute("open"); }
    }

    function updateAll(){
      // Badge filter label
      const f = [];
      const q = $("#q").value.trim();
      const p = $("#purpose").value;
      const r = $("#risk").value;
      if(q) f.push(`検索="${q}"`);
      if(p) f.push(`目的="${p}"`);
      if(r) f.push(`リスク="${r}"`);
      $("#badgeFilter").textContent = `フィルタ: ${f.length ? f.join(" / ") : "なし"}`;

      renderKpis(FILTERED);
      destroyCharts();
      buildPurposeChart(FILTERED);
      buildChurnChart(FILTERED);
      renderPurposeTable(FILTERED);
      renderOperatorTable(FILTERED);
      renderRecordsTable(FILTERED);

      setSubtitle(`フィルタ適用後: ${FILTERED.length.toLocaleString("ja-JP")} 件 / 全 ${ALL.length.toLocaleString("ja-JP")} 件`);
    }

    // =========================
    // Tabs (a11y)
    // =========================
    const tabs = [
      { btn:"#tabOverview", panel:"#panelOverview" },
      { btn:"#tabByPurpose", panel:"#panelByPurpose" },
      { btn:"#tabOperators", panel:"#panelOperators" },
      { btn:"#tabRecords", panel:"#panelRecords" },
    ];

    function activateTab(btnSel){
      for(const t of tabs){
        const btn = $(t.btn);
        const panel = $(t.panel);
        const on = (t.btn === btnSel);
        btn.setAttribute("aria-selected", on ? "true" : "false");
        panel.style.display = on ? "" : "none";
      }
    }

    // =========================
    // Load
    // =========================
    async function loadData(){
      $("#loadingBox").style.display = "";
      $("#mainContent").style.display = "none";
      setSubtitle("読み込み中…");
      setStatus("読み込み中…");

      // "数秒ロードしてる感"の演出（最低 900ms は表示）
      const minDelay = new Promise(res => setTimeout(res, 900));

      let res, json;
      try{
        res = await fetch(DATA_URL, { cache: "no-store" });
        if(!res.ok) throw new Error(`fetch failed: ${res.status} ${res.statusText}`);
        json = await res.json();
      }catch(e){
        await minDelay;
        $("#loadingBox").style.display = "none";
        setSubtitle("読み込み失敗");
        setStatus("読み込み失敗");
        toast("読み込み失敗", `./data/voc.json を取得できませんでした（${e.message}）`, "danger", 8000);
        return;
      }

      await minDelay;

      if(!Array.isArray(json)){
        $("#loadingBox").style.display = "none";
        setSubtitle("読み込み失敗");
        setStatus("読み込み失敗");
        toast("形式エラー", "voc.json は配列(JSON Array)である必要があります", "danger", 8000);
        return;
      }

      ALL = json;
      FILTERED = [...ALL];

      renderPurposeSelect();
      $("#loadingBox").style.display = "none";
      $("#mainContent").style.display = "";
      setStatus(`読み込み完了：${ALL.length.toLocaleString("ja-JP")}件`);

      toast("読み込み完了", `${ALL.length.toLocaleString("ja-JP")} 件を読み込みました`, "ok");

      updateAll();
    }

    // =========================
    // Events
    // =========================
    function bindEvents(){
      // Tabs
      tabs.forEach(t=>{
        $(t.btn).addEventListener("click", ()=> activateTab(t.btn));
      });

      // Filters
      $("#q").addEventListener("input", debounce(applyFilters, 180));
      $("#purpose").addEventListener("change", applyFilters);
      $("#risk").addEventListener("change", applyFilters);
      $("#sort").addEventListener("change", ()=>{ page = 1; renderRecordsTable(FILTERED); });

      $("#btnReset").addEventListener("click", ()=>{
        $("#q").value = "";
        $("#purpose").value = "";
        $("#risk").value = "";
        $("#sort").value = "date_desc";
        toast("リセット", "フィルタを解除しました", "ok");
        applyFilters();
      });

      $("#btnReload").addEventListener("click", ()=> loadData());
      $("#btnOpenJson").addEventListener("click", ()=> window.open(DATA_URL, "_blank"));

      $("#btnDemoToast").addEventListener("click", ()=>{
        toast("デモ", "トースト表示のサンプルです", "ok");
      });

      // Records paging
      $("#btnMore").addEventListener("click", ()=>{
        page++;
        renderRecordsTable(FILTERED);
      });

      // Infinite scroll
      const io = new IntersectionObserver((entries)=>{
        const e = entries[0];
        if(e.isIntersecting){
          // Load next page quietly
          const totalShown = pageSize * page;
          if(totalShown < sortRows(FILTERED).length){
            page++;
            renderRecordsTable(FILTERED);
          }
        }
      }, { root: null, threshold: 1.0 });
      io.observe($("#sentinel"));

      // Dialog
      $("#btnClose").addEventListener("click", closeDialog);
      $("#btnClose2").addEventListener("click", closeDialog);
      $("#dlg").addEventListener("click", (ev)=>{
        // click outside content closes
        const rect = $("#dlg").getBoundingClientRect();
        const inDialog = (ev.clientX >= rect.left && ev.clientX <= rect.right && ev.clientY >= rect.top && ev.clientY <= rect.bottom);
        if(!inDialog) closeDialog();
      });

      // ESC close toast hint
      document.addEventListener("keydown", (ev)=>{
        if(ev.key === "Escape"){
          // dialog closes naturally; just in case
          const dlg = $("#dlg");
          if(dlg.open) closeDialog();
        }
      });
    }

    function debounce(fn, ms){
      let t = null;
      return (...args)=>{
        clearTimeout(t);
        t = setTimeout(()=>fn(...args), ms);
      };
    }

    // =========================
    // Boot
    // =========================
    bindEvents();
    loadData();
  </script>
</body>
</html>
